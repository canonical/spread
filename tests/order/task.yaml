summary: Test the MATCH function.

prepare: |
    if [ ! -f .spread-reuse.yaml ]; then
        touch /run/spread-reuse.yaml
        ln -s /run/spread-reuse.yaml .spread-reuse.yaml
    fi

restore: |
    rm -f exec1.out exec2.out exec3.out

execute: |
    # Check the order is the desired when using -order option
    spread -order -reuse -resend lxd:ubuntu-16.04:checks/task-b lxd:ubuntu-16.04:checks/task-c lxd:ubuntu-16.04:checks/task-a lxd:ubuntu-16.04:checks/task-d &> exec1.out
    MATCH 'task-b.*(1/4)' < exec1.out
    MATCH 'task-c.*(2/4)' < exec1.out
    MATCH 'task-a.*(3/4)' < exec1.out
    MATCH 'task-d.*(4/4)' < exec1.out
    MATCH 'Successful tasks: 4' < exec1.out

    # Check the order is the desired with a different set of tests when using -order option
    spread -order -reuse -resend lxd:ubuntu-16.04:checks/task-d lxd:ubuntu-16.04:checks/task-a lxd:ubuntu-16.04:checks/task-e &> exec2.out
    MATCH 'task-d.*(1/3)' < exec2.out
    MATCH 'task-a.*(2/3)' < exec2.out
    MATCH 'task-e.*(3/3)' < exec2.out
    MATCH 'Successful tasks: 3' < exec2.out

    # Check the order could not be followed when the -order option is not used
    for i in $(seq 30); do
        spread -reuse -resend lxd:ubuntu-16.04:checks/task-b lxd:ubuntu-16.04:checks/task-c lxd:ubuntu-16.04:checks/task-a lxd:ubuntu-16.04:checks/task-d &> exec3.out
        if NOMATCH 'task-b.*(1/4)' < exec3.out; then
            break
        fi
    done
    NOMATCH 'task-b.*(1/4)' < exec3.out

debug: |
    cat exec1.out || true
    cat exec2.out || true
    cat exec3.out || true
