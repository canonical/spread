summary: Test the lxd backend.

prepare: |
    if [ ! -f .spread-reuse.yaml ]; then
        touch /run/spread-reuse.yaml
        ln -s /run/spread-reuse.yaml .spread-reuse.yaml
    fi

execute: |
    spread -vv -reuse -resend lxd-a &> task.out
    spread -vv -reuse -resend lxd-b &>> task.out
    spread -vv -reuse -resend lxd-c &>> task.out

    for system in ubuntu-16.04 ubuntu-18.04; do
        grep "lxd-a:${system}:checks/main" task.out
        grep "^WORKS NPROC=[[:digit:]]\+ VM=0 ${system}\$" task.out
    done

    for system in ubuntu-20.04 ubuntu-22.04; do
        grep "lxd-b:${system}:checks/main" task.out
        grep "^WORKS NPROC=[[:digit:]]\+ VM=0 ${system}\$" task.out
    done

    for system in ubuntu-24.04; do
        grep "lxd-c:${system}:checks/main" task.out
        grep "^WORKS NPROC=[[:digit:]]\+ VM=0 ${system}\$" task.out
    done

    for system in ubuntu-24.04-with-plan; do
        grep "lxd-c:${system}:checks/main" task.out
        grep "^WORKS NPROC=1 VM=0 ${system}\$" task.out
    done

debug: |
    cat task.out || true
